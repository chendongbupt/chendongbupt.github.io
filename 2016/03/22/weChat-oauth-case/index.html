<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> weChat oauth case · CDBlog</title><meta name="description" content="weChat oauth case - chendong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="CDBlog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">weChat oauth case</h1><div class="post-info">Mar 22, 2016</div><div class="post-content"><h3 id="公众号认证授权的几种场景"><a href="#公众号认证授权的几种场景" class="headerlink" title="公众号认证授权的几种场景"></a>公众号认证授权的几种场景</h3><p>上篇博文写过了，微信授权有UnionID和Oauth2.0两种机制及两者的差别，不清楚的详见<a href="http://chendongbupt.github.io/2016/03/21/weChatOauth/" target="_blank" rel="noopener">微信授权</a>。</p>
<h4 id="case-1-推广营销活动"><a href="#case-1-推广营销活动" class="headerlink" title="case 1: 推广营销活动"></a>case 1: 推广营销活动</h4><p>商家让利，会有对用户的各种优惠折扣，基于口碑拓展，KPI，用户数据？ 这些猜测不重要， 关键<strong>希望公众号涨粉</strong>，至少是数据上。<br>而很多用户也确实愿意褥羊毛，趁机捡点便宜，反正也就在微信里面点几下，填几下~~<br>这种情况就需要用户关注了，因为很多统计的是关注的用户数~~  这时候就需要UnionID机制的授权了，对没有关注的用户进行提示并跳转到一个可关注的页面。<br>UnionID授权机制 伪代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">require_once(dirname(__FILE__). &apos;../cls_oauth.php&apos;); //引入cls</span><br><span class="line">$Oauth = new Oauth($db);  </span><br><span class="line">$code = htmlspecialchars($_GET[&apos;code&apos;])? htmlspecialchars($_GET[&apos;code&apos;]):&apos;&apos;;</span><br><span class="line">	if ( !$code )&#123;</span><br><span class="line">        $Oauth-&gt;basicOauth($curUrl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    $userinfo = $Oauth-&gt;getGlobalUserinfoByCode($code);  // 全局token取用户基本信息， 可以取到是否用户关注公众号</span><br><span class="line"></span><br><span class="line">	//未关注公众号， 不能得到 用户其他信息</span><br><span class="line">    if ( $userinfo[&apos;subscribe&apos;] != 1)&#123;</span><br><span class="line">        //todo code</span><br><span class="line">        header(&quot;Location: subscribe.html&quot;);  </span><br><span class="line">        exit ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //已关注公众号</span><br><span class="line">    //todo code</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<h4 id="case-2-各种不设门槛的投票活动"><a href="#case-2-各种不设门槛的投票活动" class="headerlink" title="case 2: 各种不设门槛的投票活动"></a>case 2: 各种不设门槛的投票活动</h4><p>很多投票活动并不对用户设置投票条件，除了每人每天一票这种~~  这种活动并不在意用户是否关注公众号，倒是希望更多的人参与。而关注公众号是一个”复杂”的操作,毕竟无利不起早<del>~</del>~<br>Oauth2.0授权机制 伪代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if ( !$code )</span><br><span class="line">      $Oauth-&gt;userinfoOauth($curUrl);</span><br><span class="line"></span><br><span class="line">  $userinfo = $Oauth-&gt;getUserinfoByCode($code);  //网页授权取用户信息</span><br></pre></td></tr></table></figure></p>
<p>囧， 好少！！  oauth封装的class 在cls_oauth.php中，上篇博客有过程分析，地址<a href="https://github.com/chendongbupt/blog-example/blob/master/cls_oauth.php" target="_blank" rel="noopener">https://github.com/chendongbupt/blog-example/blob/master/cls_oauth.php</a>。</p>
<h4 id="case-3：微商城"><a href="#case-3：微商城" class="headerlink" title="case 3：微商城"></a>case 3：微商城</h4><p>比如微信入口某东， 第一次进入，点击授权确认，需要详细授权取到用户信息，免除了注册与登录， 之后直接凭借openid直接登录。<br>过程：<br>1 Oauth2.0 授权第一步，basic授权取到用户openid<br>2 openid在数据库、SESSION、localStroge、缓存==中，直接设置用户为登录状态， 结束 ~<br>3 openid第一次访问，重新进行snsapi_userinfo授权，取到详细数据，数据库注册、写入缓存、文件===</p>
<p>一开始用basic授权的原因是， basic属于静默授权，不会弹出绿色授权确认页面，只在链接状态栏上有显示”微信授权xxxx”，更多的用户会经常访问，多次出现授权确认不理想。<br>伪代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$code = htmlspecialchars($_GET[&apos;code&apos;])? htmlspecialchars($_GET[&apos;code&apos;]):&apos;&apos;;</span><br><span class="line">$state = htmlspecialchars($_GET[&apos;state&apos;])? htmlspecialchars($_GET[&apos;state&apos;]):&apos;&apos;;</span><br><span class="line"></span><br><span class="line">if (!$code &amp;&amp; $state != &apos;reg&apos;)&#123;</span><br><span class="line">       $Oauth-&gt;basicOauth($curUrl);</span><br><span class="line">   &#125;</span><br><span class="line">   $userinfo = $Oauth-&gt;getOauthInfo($code);  //取到 openid</span><br><span class="line"></span><br><span class="line">   if ( check($userinfo[&apos;openid&apos;]) )&#123;</span><br><span class="line">       // 根据 openid 查询， 如果SESSION 或者 数据库 中有 该openid， 直接登录</span><br><span class="line">       //todo code</span><br><span class="line">   &#125;</span><br><span class="line">   else&#123;</span><br><span class="line">   // 该用户信息不存在</span><br><span class="line">   // 处理-- 可以提示  -- 也可以再次授权取到信息并插入数据</span><br><span class="line">   // $code需要新申请， 需要state变量避免陷入死循环</span><br><span class="line">   	if ( !$code &amp;&amp; $state == &apos;reg&apos;)  // state 可以自己设置，cls.php 文件设置的为 &apos;reg&apos;</span><br><span class="line">       	$Oauth-&gt;userinfoOauth($curUrl);</span><br><span class="line"></span><br><span class="line">   	$userinfo = $Oauth-&gt;getUserinfoByCode($code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/03/23/oauth-url-filter/" class="prev">上一篇</a><a href="/2016/03/21/weChatOauth/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">chendong</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>