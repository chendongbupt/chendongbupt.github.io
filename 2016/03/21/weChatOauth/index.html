<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 微信授权 · CDBlog</title><meta name="description" content="微信授权 - chendong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="CDBlog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">微信授权</h1><div class="post-info">Mar 21, 2016</div><div class="post-content"><p>微信授权有两种： 一种是<a href="http://mp.weixin.qq.com/wiki/1/8a5ce6257f1d3b2afb20f83e72b72ce9.html" target="_blank" rel="noopener">UnionID机制的授权</a>， 还有一种是<a href="http://mp.weixin.qq.com/wiki/4/9ac2e7b1f1d22e9e57260f6553822520.html" target="_blank" rel="noopener">Oauth 2.0的网页授权</a>。</p>
<h3 id="UnionID机制授权"><a href="#UnionID机制授权" class="headerlink" title="UnionID机制授权"></a>UnionID机制授权</h3><p>UnionID机制授权需要 openid 和 全局的access_token,与网页授权的access_token不同,这个全局token每天有更新次数限制，而网页授权token是无限的。<br>请求链接： <a href="https://api.weixin.qq.com/cgi-bin/user/info?access_token=ACCESS_TOKEN&amp;openid=OPENID&amp;lang=zh_CN" target="_blank" rel="noopener">https://api.weixin.qq.com/cgi-bin/user/info?access_token=ACCESS_TOKEN&amp;openid=OPENID&amp;lang=zh_CN</a><br>关注的用户返回数据格式：<br>{<br>   <strong> “subscribe”: 1,  </strong><br>    “openid”: “o6_bmjrPTlm6_2sgVt7hMZOPfL2M”,<br>    “nickname”: “Band”,<br>    “sex”: 1,<br>    “language”: “zh_CN”,<br>    “city”: “广州”,<br>    “province”: “广东”,<br>    “country”: “中国”,<br>    “headimgurl”:    “<a href="http://wx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0&quot;" target="_blank" rel="noopener">http://wx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0&quot;</a>,<br>  <strong> “subscribe_time”: 1382694957, </strong><br>   “unionid”: “ o6_bmasdasdsad6_2sgVt7hMZOPfL”<br>   “remark”: “”,<br>   “groupid”: 0<br>}<br>，未关注则返回：<br>{<br>“subscribe”: 0，<br>“openid”: “o6_bmjrPTlm6_2sgVt7hMZOPfL2M”<br>}</p>
<h4 id="openid"><a href="#openid" class="headerlink" title="openid"></a>openid</h4><p>每个用户具有唯一的openid，用户与微信、公众号消息交互的时候都会传递openid，所以解析回调的XML是可以得到openid的。当然，也可以用一些请求链接获取，<br>比如 网页Oauth2.0授权的第一步<code>https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</code> 。<br><a id="more"></a></p>
<h4 id="全局的access-token"><a href="#全局的access-token" class="headerlink" title="全局的access_token"></a>全局的access_token</h4><p>这个access_token文档在这里<a href="http://mp.weixin.qq.com/wiki/14/9f9c82c1af308e3b14ba9b973f99a8ba.html" target="_blank" rel="noopener">http://mp.weixin.qq.com/wiki/14/9f9c82c1af308e3b14ba9b973f99a8ba.html</a>， 获取链接<code>https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</code>。<br>返回数据格式：{“access_token”:”ACCESS_TOKEN”,”expires_in”:7200}</p>
<h4 id="代码步骤"><a href="#代码步骤" class="headerlink" title="代码步骤"></a>代码步骤</h4><ul>
<li>Oauth2.0授权第一步，取到openid</li>
<li>取到全局access_token</li>
<li>UnionID机制 链接取到用户基本信息</li>
</ul>
<h3 id="网页Oauth2-0的授权"><a href="#网页Oauth2-0的授权" class="headerlink" title="网页Oauth2.0的授权"></a>网页Oauth2.0的授权</h3><p>官方文档给出的相关API及步骤如下：<br>1 第一步：用户同意授权，获取code<br>2 第二步：通过code换取网页授权access_token<br>3 第三步：刷新access_token（如果需要）<br>4 第四步：拉取用户信息(需scope为 snsapi_userinfo)<br>5 附：检验授权凭证（access_token）是否有效</p>
<p>其中，直接的授权步骤为：<br>取openid -&gt;  换取access_token -&gt; 拉取用户数据</p>
<h4 id="取openid"><a href="#取openid" class="headerlink" title="取openid"></a>取openid</h4><p>步骤1提供了两种授权作用域 snsapi_base和snsapi_userinfo。<br><code>snsapi_base</code> 只能到步骤2，换取access_token 结束。<br><code>snsapi_userinfo</code> 则能到步骤3， 获取用户信息。<br>所以， 一般情况直接用 <code>snsapi_userinfo</code> 授权，可以直接走完步骤取用户信息。</p>
<h4 id="access-token"><a href="#access-token" class="headerlink" title="access_token"></a>access_token</h4><p>这个token是指网页授权的token，每天可以<strong>无限制</strong>的请求。<br>需要用步骤1返回的code来换取。<br>在请求的时候，可以传递一个 state 参数，这个参数是有用户的(优化代码逻辑，避免在第一步死循环请求)。</p>
<h4 id="拉取用户信息"><a href="#拉取用户信息" class="headerlink" title="拉取用户信息"></a>拉取用户信息</h4><p>直接用上述获取的两个参数请求，<strong>不论用户是否关注公众号</strong>， 数据格式：<br>{<br>   “openid”:” OPENID”,<br>   “ nickname”: NICKNAME,<br>   “sex”:”1”,<br>   “province”:”PROVINCE”<br>   “city”:”CITY”,<br>   “country”:”COUNTRY”,<br>    “headimgurl”:    “<a href="http://wx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/46&quot;" target="_blank" rel="noopener">http://wx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/46&quot;</a>,<br>    “privilege”:[<br>    “PRIVILEGE1”<br>    “PRIVILEGE2”<br>    ],<br>    “unionid”: “o6_bmasdasdsad6_2sgVt7hMZOPfL”<br>}</p>
<p>对比UnionID机制，没有用户的<strong> 关注信息 </strong> 。</p>
<h4 id="代码步骤-1"><a href="#代码步骤-1" class="headerlink" title="代码步骤"></a>代码步骤</h4><ul>
<li>snsapi_userinfo取code</li>
<li>取到access_token</li>
<li>取用户数据</li>
</ul>
<h3 id="UnionID-VS-Oauth2-0"><a href="#UnionID-VS-Oauth2-0" class="headerlink" title="UnionID VS Oauth2.0"></a>UnionID VS Oauth2.0</h3><p>本次博文的重点来了。</p>
<h4 id="UnionID"><a href="#UnionID" class="headerlink" title="UnionID :"></a>UnionID :</h4><ul>
<li>全局的access_token的调用次数是有限的，所以就需要我们维护access_token的生存期，比如写入数据库或者缓存，一定时间进行更新。</li>
<li>能返回用户的 <strong>关注信息</strong></li>
<li>未关注用户不能得到基本信息</li>
<li>属于<strong>静默授权</strong>，无需用户点击授权(就是那个绿色的授权页面不会弹出)</li>
</ul>
<h4 id="Oauth2-0"><a href="#Oauth2-0" class="headerlink" title="Oauth2.0 :"></a>Oauth2.0 :</h4><ul>
<li>调用次数无限</li>
<li>无论是否关注都能取到基本信息</li>
<li>需要用户点击授权</li>
<li>无法得到关注信息</li>
</ul>
<p>最后， 献上实例代码 <a href="https://github.com/chendongbupt/blog-example/blob/master/cls_oauth.php" target="_blank" rel="noopener">https://github.com/chendongbupt/blog-example/blob/master/cls_oauth.php</a></p>
<p>下一节讲述 <strong>部分授权场景</strong></p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/03/22/weChat-oauth-case/" class="prev">PREV</a><a href="/2016/03/19/tanslateZ-3D/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">chendong</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>