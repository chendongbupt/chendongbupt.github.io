<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 初次开发hybrid H5的坑及方案 · CDBlog</title><meta name="description" content="初次开发hybrid H5的坑及方案 - chendong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="CDBlog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">初次开发hybrid H5的坑及方案</h1><div class="post-info">Mar 2, 2019</div><div class="post-content"><h4 id="hybrid-h5"><a href="#hybrid-h5" class="headerlink" title="hybrid h5"></a>hybrid h5</h4><p>hybrid 翻译为杂交， hyrid h5 是指将web前端页面嵌入到原生APP( iOS和Android )中的运行的方案。<br>相对于原生开发，web前端的开发发展时间更长、从业人员更多、生态更为繁荣，而且开发效率也更高。<br>但web并不能直接调用原生API，而且运行内存、调度也差与原生，流畅性就显得不足。<br>基于以上原因，协调开发资源，将一些展示性、交互不多的页面让web开发，嵌入原生Webview中运行，就可以大大提高APP开发效率，利用团队开发资源。</p>
<a id="more"></a>
<h4 id="h5调用原生方法"><a href="#h5调用原生方法" class="headerlink" title="h5调用原生方法"></a>h5调用原生方法</h4><p>参考 (<a href="https://github.com/marcuswestin/WebViewJavascriptBridge" target="_blank" rel="noopener">https://github.com/marcuswestin/WebViewJavascriptBridge</a>)</p>
<ol>
<li>直接注入调用<br>iOS能访问Webview下全局对象window，所以可以将js方法挂载到window上，然后iOS调用；<br>安卓的话可以注入方法到window上，然后js调用这原生方法。</li>
<li>协议监听<br>原生API能拦截Webview的网络请求，url根据协议传参，原生解析后执行，将结果挂载到window上。<br>js的url实现方法：<br> 2.1 window.location.href<br> 2.2 利用页面中嵌套的iframe的url(将iframe的长宽都设为很小或者0，取到数据后再移除这个iframe)建议使用②iframe的方式，因为如果我们连续多次修改window.location.href的值，在Native层只能接收到最后一次请求，前面的请求都会被忽略掉。</li>
<li>引入JsBridge（安卓）和 WebViewJavascriptBridge（iOS）库的方案<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 安卓运行</span><br><span class="line">// 如果WebViewJavascriptBridge已挂载，直接执行，否则，等待WebViewJavascriptBridgeReady时间触发，即原生方法已挂载后执行</span><br><span class="line">if (window.WebViewJavascriptBridge) &#123;</span><br><span class="line">    //do your work here</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    document.addEventListener(</span><br><span class="line">        &apos;WebViewJavascriptBridgeReady&apos;</span><br><span class="line">        , function() &#123;</span><br><span class="line">            //do your work here</span><br><span class="line">        &#125;,</span><br><span class="line">        false</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// iOS运行</span><br><span class="line">function setupWebViewJavascriptBridge(callback) &#123;</span><br><span class="line">	if (window.WebViewJavascriptBridge) &#123; return callback(WebViewJavascriptBridge); &#125;</span><br><span class="line">	if (window.WVJBCallbacks) &#123; return window.WVJBCallbacks.push(callback); &#125;</span><br><span class="line">	window.WVJBCallbacks = [callback];</span><br><span class="line">	var WVJBIframe = document.createElement(&apos;iframe&apos;);</span><br><span class="line">	WVJBIframe.style.display = &apos;none&apos;;</span><br><span class="line">	WVJBIframe.src = &apos;https://__bridge_loaded__&apos;;</span><br><span class="line">	document.documentElement.appendChild(WVJBIframe);</span><br><span class="line">	setTimeout(function() &#123; document.documentElement.removeChild(WVJBIframe) &#125;, 0)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>此次项目，我们直接进行的注入调用。<br>h5中涉及到摄像头拍照的功能，由原生提供，注入到h5中，挂载到window.api上，js则可以直接调用方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.api.camera(params, function()&#123;&#125;)    // 调用原生注入的API，参数不可缺少，传递params参数以及回调函数</span><br></pre></td></tr></table></figure></p>
<p>html中引入一个固定名称的js文件供安卓注入，比如 android.js， 兼容安卓5，文件不能为空，所以可以声明一个无关紧要的变量或者console。</p>
<h4 id="兼容遇到的问题"><a href="#兼容遇到的问题" class="headerlink" title="兼容遇到的问题"></a>兼容遇到的问题</h4><ol>
<li>安卓5下需要对Promise reject进行处理，否在抛错</li>
<li>es6 spread语法， …obj， 低版本下需要确定obj为Object,如果为’’，会抛错</li>
<li>iOS调用js方法时，内部不能有Promise，否则会卡死，不执行回调</li>
<li>用iframe时，iOS会需要src同源，否则会解析失败</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2018/12/02/小程序探索/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">chendong</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>